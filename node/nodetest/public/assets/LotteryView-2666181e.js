import{r as m,i as X,o as w,c as x,e as s,l as g,b2 as E,F,b3 as U,p as q,m as z,b as O,w as G,d as C,j as $,v as H,b4 as K,k as Q}from"./index-2bed0a42.js";import{C as D}from"./index-67d73b85.js";import{V as Y,L as Z,r as ee}from"./Animation - 1690257463274-70d57635.js";import{r as te,u as _,w as se}from"./xlsx-bd534488.js";import{N as le}from"./Modal-c65e03f4.js";import"./Warning-473e46f6.js";const oe={class:"container-fluid p-md-4 pt-5",style:{"background-color":"#efefef"}},ae=s("h1",{class:"fw-bold fs-1 text-center"},"地區活動抽獎網站",-1),ne=s("div",{class:"row"},null,-1),re={class:"row mb-md-5"},ie={class:"col-md-6 gx-md-5 mb-3 mb-md-0"},ue=s("label",{for:"name",class:"form-label fw-bolder fs-3"},[s("i",{class:"bi bi-star-fill me-1",style:{color:"#18a058"}}),$("名稱:")],-1),ce={class:"col-md-6 gx-md-5 mb-3 mb-md-0"},de={class:"row"},fe=s("div",{class:"col-12"},[s("label",{for:"gift",class:"form-label fw-bolder fs-3"},[s("i",{class:"bi bi-sliders me-1",style:{color:"#18a058"}}),$("獎品設定:")])],-1),pe={class:"input-group"},me=["onUpdate:modelValue"],he=["onUpdate:modelValue"],be=["value"],ve={class:"col-auto"},ge={class:"row"},_e={class:"mb-md-5 gx-md-5 mb-3 mb-md-0"},ye={class:"row"},we=s("div",{class:"col-auto"},[s("label",{for:"userlist",class:"form-label fw-bolder fs-3"},[s("i",{class:"bi bi-person-fill-up me-1",style:{color:"#18a058"}}),$("抽獎名單:")])],-1),xe={class:"col-auto"},ke={key:0,class:"gx-md-5 mb-3 mb-md-0"},Se=s("label",{for:"giftlist",class:"form-label fw-bolder fs-3"},[s("i",{class:"bi bi-cash-coin me-1",style:{color:"#18a058"}}),$("中獎結果:")],-1),Oe={__name:"LotteryView",setup(Ee){const k=m(!1),y=m(),V=m(),S=m(),f=m([]),T=X("$swal"),L=m();async function v(o){T({icon:"error",title:`${o}`,showConfirmButton:!1})}let N=null;const h=m([]),A=o=>{const l=o.target.files[0],t=new FileReader;t.readAsArrayBuffer(l),t.onload=n=>{const c=n.target.result,d=te(c,{type:"binary",codepage:65001,raw:!0}),r=d.SheetNames[0],i=d.Sheets[r],u=_.sheet_to_json(i,{header:1,blankrows:!1});h.value=[...u];let e="";u.forEach((a,b)=>{b===0&&(N=a),e+=`${a}
`}),V.value=e}};function B(o,l){var t=D.AES.decrypt(o,l),n=t.toString(D.enc.Utf8);return JSON.parse(n)}const J=async()=>{const o="https://report.youbike.com.tw/lottery/blacklist",t=(await Q.get(o)).data.data;let n={mobile:[],cardno:[]};return t.forEach(c=>{n.mobile.push(B(c.mobile,"CryptoJS_PASSWORD")),n.cardno.push(c.cardno)}),n},p=m([{name:null,value:1,key:1}]),I=()=>{const o=p.value.length+1;p.value.push({name:null,value:1,key:o})},M=()=>{p.value.length>1&&p.value.pop()},j=async()=>{const o=await J();let l=[];f.value=[];const t=h.value[0].indexOf("合計票數");h.value.forEach((e,a)=>{if(a!==0)for(let b=1;b<=e[t];b++)l.push(e)});let n=[];if(p.value.forEach(e=>{for(let a=1;a<=e.value;a++)n.push(e.name)}),l.length<n.length)return v("抽獎人小於獎品");const c=h.value[0].indexOf("手機號碼"),d=h.value[0].indexOf("外觀卡號");if(t===-1||c===-1||d===-1)return v("excel格式錯誤");let r=[],i=0;for(;r.length!==n.length;){let e=!0;const a=ee.int(0,l.length-1);if(console.log(o,l,a,d),console.log(`giftpool[${a}]=`+l[a]),console.log(`giftpool[${a}][${d}]=`+l[a][d]),o.cardno.indexOf(l[a][d].toString())!==-1||o.mobile.indexOf(l[a][c].toString())!==-1){if(e=!1,i++,console.log(i),i===100)return v("抽獎失敗")}else i=0;r.forEach(b=>{(b[c]===l[a][c]||b[d]===l[a][d])&&(e=!1)}),e&&r.push(l[a])}r.forEach((e,a)=>{f.value.push({name:n[a],value:r[a]})});let u=`${y.value}
========================================
`;f.value.forEach((e,a)=>{a===0?u+=`${e.name}
${e.value}`:e.name===f.value[a-1].name?u+=`
${e.name}
${e.value}`:u+=`


${e.name}
${e.value}`}),S.value=u},R=()=>{if(y.value)if(p.value[0].name){if(h.value.length<1)return v("抽獎名單不能為空")}else return v("請輸入獎品設定");else return v("請輸入名稱");k.value=!0,setTimeout(function(){j(),k.value=!1},4e3)};function P(o){if(typeof o!="number")throw new Error("Input must be a number");const l=o.toString();return l.length>5?parseInt(l.substring(0,4)):o}const W=()=>{let o=[];f.value.forEach((r,i)=>{i===0?(o.push([]),o[0].push(r)):(f.value[i].name===f.value[i-1].name||o.push([]),o[o.length-1].push(r))});const l=_.book_new();o.forEach(r=>{let i=[];i.push(N),r.forEach(e=>{i.push(e.value)});const u=_.aoa_to_sheet(i);_.book_append_sheet(l,u,`${r[0].name}`)});const t={台北:[],"台北2.0":[],新北:[],"新北2.0":[],桃園:[],"桃園2.0":[],竹市:[],"竹市2.0":[],"竹縣2.0":[],竹科:[],"竹科2.0":[],苗栗:[],"苗栗2.0":[],台中:[],"台中2.0":[],彰化:[],"彰化2.0":[],"嘉義2.0":[],"台南2.0":[],"高雄2.0":[],"屏東2.0":[]},n=h.value[0].indexOf("借車場站代號");if(n>0){f.value.forEach(u=>{const e=P(parseInt(u.value[n]));e>=1&&e<=900?t.台北.push(e):e>=1001&&e<=1900?t.新北.push(e):e>=2001&&e<=2900?t.桃園.push(e):e>=3001&&e<=3900?t.台中.push(e):e>=6101&&e<=6290?t.竹市.push(e):e>=6601&&e<=6990?t.苗栗.push(e):e>=7001&&e<=7290?t.彰化.push(e):e>=9601&&e<=9696?t.竹科.push(e):e==5001?t["台北2.0"].push(e):e==5002?t["新北2.0"].push(e):e==5003?t["桃園2.0"].push(e):e==5004?t["竹市2.0"].push(e):e==5005?t["竹縣2.0"].push(e):e==5006?t["台中2.0"].push(e):e==5007?t["苗栗2.0"].push(e):e==5008?t["彰化2.0"].push(e):e==5010?t["嘉義2.0"].push(e):e==5012?t["高雄2.0"].push(e):e==5013?t["台南2.0"].push(e):e==5014?t["屏東2.0"].push(e):e==5082&&t["竹科2.0"].push(e)});const r=[["贈品區域","配送數量"]];for(const u in t){let e=[u,t[u].length];r.push(e)}const i=_.aoa_to_sheet(r);_.book_append_sheet(l,i,"城市分類")}const c=`${y.value}.xlsx`;se(l,c,{bookType:"xlsx"})};return(o,l)=>(w(),x("div",oe,[ae,ne,s("div",re,[s("div",ie,[ue,g(s("input",{type:"email","onUpdate:modelValue":l[0]||(l[0]=t=>y.value=t),class:"form-control",id:"name",placeholder:"請輸入名稱"},null,512),[[E,y.value]])]),s("div",ce,[s("div",de,[fe,(w(!0),x(F,null,U(p.value,t=>(w(),x("div",{class:"mb-2 col-lg-6 col-xxl-4",key:t.key},[s("div",pe,[g(s("input",{type:"input",class:"form-control","onUpdate:modelValue":n=>t.name=n,placeholder:"請輸入名稱"},null,8,me),[[E,t.name]]),g(s("select",{class:"form-select","onUpdate:modelValue":n=>t.value=n},[(w(),x(F,null,U(700,n=>s("option",{key:`${n}12`,value:n},K(n),9,be)),64))],8,he),[[H,t.value]])])]))),128)),s("div",{class:"col-auto"},[s("button",{type:"button",class:"btn btn-outline-primary",onClick:I}," 新增 ")]),g(s("div",ve,[s("button",{type:"button",class:"btn btn-outline-danger",onClick:M}," 刪除 ")],512),[[q,p.value.length>1]])])])]),s("div",ge,[s("div",_e,[s("div",ye,[we,s("div",xe,[s("input",{type:"file",id:"excelFileInput",onChange:A,ref_key:"file",ref:L,class:"form-control"},null,544)])]),g(s("textarea",{class:"form-control",id:"userlist",rows:"10","onUpdate:modelValue":l[1]||(l[1]=t=>V.value=t),readonly:"",placeholder:`得獎限制: 手機號碼和外觀卡號均不能重複\r
EXCEL格式需填寫 <手機號碼> <外觀卡號> <合計票數>\r
                `},null,512),[[E,V.value]])]),s("div",{class:"row"},[s("div",{class:"gx-md-5 mb-3 mb-md-0 text-center"},[s("button",{type:"button",class:"btn btn-lg btn-danger fw-bold px-4 me-3 mb-3 mb-md-0",onClick:R}," 抽獎 ")])]),S.value?(w(),x("div",ke,[Se,g(s("textarea",{class:"form-control",readonly:"",id:"giftlist",rows:"10","onUpdate:modelValue":l[2]||(l[2]=t=>S.value=t)},null,512),[[E,S.value]]),s("div",{class:"gx-md-5 mb-3 mb-md-0 text-center mt-5"},[s("button",{type:"button",class:"btn btn-lg btn-primary fw-bold px-4 me-3",onClick:W}," 導出Excel ")])])):z("",!0)]),O(C(le),{show:k.value,"onUpdate:show":l[3]||(l[3]=t=>k.value=t),"mask-closable":!1},{default:G(()=>[O(C(Y),{animationData:C(Z),height:400,width:400,speed:1},null,8,["animationData"])]),_:1},8,["show"])]))}};export{Oe as default};
